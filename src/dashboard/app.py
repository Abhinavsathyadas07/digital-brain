"""\nStreamlit Dashboard for Digital Brain\nReal-time visualization of neural signals, predictions, and stimulation\n"""\n\nimport streamlit as st\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom matplotlib.animation import FuncAnimation\nimport sys\nimport os\n\n# Add parent directory to path\nsys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..'))\n\nfrom src.signal_simulator.hippocampus_sim import HippocampusSimulator\nfrom src.signal_processing.filter import NeuralFilter\nfrom src.signal_processing.feature_extraction import FeatureExtractor\n\n\ndef plot_neural_signals(time, signals, title="Hippocampal Neural Activity"):\n    """Plot multi-channel neural signals."""\n    fig, axes = plt.subplots(min(4, signals.shape[0]), 1, figsize=(12, 6))\n    if signals.shape[0] == 1:\n        axes = [axes]\n    \n    for i in range(min(4, signals.shape[0])):\n        axes[i].plot(time[:1000], signals[i, :1000], linewidth=0.5)\n        axes[i].set_ylabel(f'Ch {i+1} (ŒºV)')\n        axes[i].set_xlim(time[0], time[999])\n        axes[i].grid(alpha=0.3)\n    \n    axes[-1].set_xlabel('Time (s)')\n    plt.suptitle(title)\n    plt.tight_layout()\n    return fig\n\n\ndef plot_frequency_bands(theta, gamma, time):\n    """Plot theta and gamma frequency bands."""\n    fig, axes = plt.subplots(2, 1, figsize=(12, 5))\n    \n    axes[0].plot(time[:1000], theta[:1000], color='blue', linewidth=0.8)\n    axes[0].set_ylabel('Theta (4-12 Hz)')\n    axes[0].set_title('Theta Rhythm (Memory Encoding)')\n    axes[0].grid(alpha=0.3)\n    \n    axes[1].plot(time[:1000], gamma[:1000], color='red', linewidth=0.8)\n    axes[1].set_ylabel('Gamma (30-100 Hz)')\n    axes[1].set_xlabel('Time (s)')\n    axes[1].set_title('Gamma Rhythm (Memory Retrieval)')\n    axes[1].grid(alpha=0.3)\n    \n    plt.tight_layout()\n    return fig\n\n\ndef main():\n    st.set_page_config(page_title="Digital Brain", layout="wide", page_icon="üß†")\n    \n    # Title and description\n    st.title("üß† Digital Brain: Neural Prosthetic Simulator")\n    st.markdown("""\n    **Real-time simulation of hippocampal memory restoration system for Alzheimer's Disease**\n    \n    This dashboard demonstrates a Brain-Computer Interface that captures electrical signals from \n    the nervous system and acts as a substitute for damaged hippocampal regions.\n    """)\n    \n    # Sidebar controls\n    st.sidebar.header("Simulation Parameters")\n    \n    signal_type = st.sidebar.radio(\n        "Neural Signal Type",\n        ["Normal (Healthy)", "Impaired (Alzheimer's)"]\n    )\n    impaired = signal_type == "Impaired (Alzheimer's)"\n    \n    num_channels = st.sidebar.slider("Number of Electrodes", 4, 16, 8)\n    duration = st.sidebar.slider("Duration (seconds)", 1.0, 5.0, 2.0, 0.5)\n    \n    if st.sidebar.button("Generate New Signals", type="primary"):\n        st.session_state['regenerate'] = True\n    \n    # Generate signals\n    if 'regenerate' not in st.session_state:\n        st.session_state['regenerate'] = True\n    \n    if st.session_state['regenerate']:\n        with st.spinner('Generating hippocampal signals...'):\n            sim = HippocampusSimulator(sampling_rate=1000, num_channels=num_channels)\n            time, signals = sim.generate_memory_encoding_pattern(duration=duration, impaired=impaired)\n            \n            st.session_state['time'] = time\n            st.session_state['signals'] = signals\n            st.session_state['impaired'] = impaired\n            st.session_state['regenerate'] = False\n    \n    time = st.session_state.get('time')\n    signals = st.session_state.get('signals')\n    impaired = st.session_state.get('impaired', False)\n    \n    # Main content\n    col1, col2, col3 = st.columns(3)\n    \n    with col1:\n        st.metric("Signal Type", "Impaired" if impaired else "Normal")\n    with col2:\n        rms = np.sqrt(np.mean(signals**2))\n        st.metric("Signal RMS", f"{rms:.3f} ŒºV")\n    with col3:\n        st.metric("Channels", num_channels)\n    \n    # Plot raw signals\n    st.subheader("üìä Raw Hippocampal Signals")\n    fig1 = plot_neural_signals(time, signals, \n                              title=f"{'Impaired' if impaired else 'Normal'} Hippocampal Activity")\n    st.pyplot(fig1)\n    \n    # Signal processing\n    st.subheader("üîç Frequency Band Analysis")\n    \n    with st.spinner('Filtering signals...'):\n        filt = NeuralFilter(sampling_rate=1000)\n        theta = filt.extract_theta(signals[0, :])\n        gamma = filt.extract_gamma(signals[0, :])\n    \n    fig2 = plot_frequency_bands(theta, gamma, time)\n    st.pyplot(fig2)\n    \n    # Feature extraction\n    st.subheader("üß™ Extracted Features")\n    \n    extractor = FeatureExtractor(sampling_rate=1000)\n    freq_bands = {'theta': (4, 12), 'gamma': (30, 100), 'beta': (13, 30)}\n    powers = extractor.compute_power_spectral_density(signals[0, :], freq_bands)\n    coupling = extractor.compute_theta_gamma_coupling(theta, gamma)\n    \n    col1, col2, col3, col4 = st.columns(4)\n    with col1:\n        st.metric("Theta Power", f"{powers['theta']:.2f} ŒºV¬≤/Hz")\n    with col2:\n        st.metric("Gamma Power", f"{powers['gamma']:.2f} ŒºV¬≤/Hz")\n    with col3:\n        st.metric("Beta Power", f"{powers['beta']:.2f} ŒºV¬≤/Hz")\n    with col4:\n        st.metric("Theta-Gamma Coupling", f"{coupling:.3f}")\n    \n    # Memory prediction (mock)\n    st.subheader("üß† Memory Encoding Prediction")\n    \n    # Simple heuristic prediction based on theta power\n    memory_prob = min(1.0, powers['theta'] / 3.0) if not impaired else min(1.0, powers['theta'] / 1.5)\n    \n    col1, col2 = st.columns(2)\n    with col1:\n        st.progress(memory_prob)\n        st.write(f"**Memory Encoding Success Probability: {memory_prob:.1%}**")\n        \n        if memory_prob < 0.6:\n            st.warning("‚ö†Ô∏è Low memory encoding probability detected!")\n            st.info("üîå Closed-loop stimulation recommended")\n        else:\n            st.success("‚úÖ Healthy memory encoding detected")\n    \n    with col2:\n        st.write("**Clinical Interpretation:**")\n        if impaired:\n            st.write("- Reduced theta power indicates impaired memory formation")\n            st.write("- Decreased theta-gamma coupling suggests disrupted encoding")\n            st.write("- Neural prosthetic stimulation may restore function")\n        else:\n            st.write("- Normal theta rhythm supports memory encoding")\n            st.write("- Strong theta-gamma coupling indicates healthy function")\n            st.write("- No intervention required")\n    \n    # Footer\n    st.markdown("---")\n    st.markdown("""\n    **Digital Brain Neural Prosthetic** | Developed by Abhinav Sathyadas\n    \n    *Simulated BCI system for Alzheimer's memory restoration*\n    """)\n\n\nif __name__ == "__main__":\n    main()\n